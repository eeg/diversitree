library(diversitreeGSE)

#--------------------------------------------------
# just branches
#-------------------------------------------------- 

pars <- c(0.9, 0.8, 0.1, 0.2, 0.3, 0.5, 0.6)
y <- c(0, 0, 0, 1, 0, 0)
len <- seq(1, 30, 10)
diversitreeGSE:::solve.gse2(y, len, pars)
#            [,1]         [,2]         [,3]
# [1,] 1.00000000 1.100000e+01 2.100000e+01
# [2,] 0.02027867 4.615036e-02 4.615165e-02
# [3,] 0.10565610 1.525029e-01 1.525049e-01
# [4,] 0.15315349 2.143867e-01 2.143889e-01
# [5,] 0.13628314 3.069027e-06 1.358857e-10
# [6,] 0.08592122 4.746276e-06 2.103486e-10
# [7,] 0.09998575 5.200993e-06 2.300138e-10

ans <- diversitreeGSE:::branches.gse2(y, len, pars, 0)
#            [,1]       [,2]      [,3]      [,4]      [,5] [,6]     [,7]
# [1,]  -2.454324 0.02027867 0.1056561 0.1531535 1.5861407    1 1.163691
# [2,] -12.258150 0.04615036 0.1525029 0.2143867 0.6466178    1 1.095805
# [3,] -22.282255 0.04615165 0.1525049 0.2143889 0.6460023    1 1.093489

t(ans[, 2:4])                # E
#            [,1]       [,2]       [,3]
# [1,] 0.02027867 0.04615036 0.04615165
# [2,] 0.10565610 0.15250286 0.15250487
# [3,] 0.15315349 0.21438665 0.21438886

t(ans[,5:7] * exp(ans[,1]))  # D
#            [,1]         [,2]         [,3]
# [1,] 0.13628314 3.069027e-06 1.358857e-10
# [2,] 0.08592122 4.746276e-06 2.103486e-10
# [3,] 0.09998575 5.200993e-06 2.300138e-10

#--------------------------------------------------
# also root join
#-------------------------------------------------- 

tree <- read.tree(text="(A:1, B:2);")
states <- c(0, 1)
names(states) <- c("A", "B")
fixInNamespace("gse2.ll", "diversitreeGSE")  # intermediates = TRUE

pars <- c(0.9, 0.8, 0.1, 0.2, 0.3, 0.5, 0.6)
lnL.7par <- make.gse2(tree, states)
lnL.7par(pars)       # -4.554181
# attr(,"intermediates")$init
#            [,1]      [,2]      [,3]    [,4]     [,5]     [,6]
# [1,] 0.00000000 0.0000000 0.0000000 1.00000 0.000000 0.000000
# [2,] 0.00000000 0.0000000 0.0000000 0.00000 1.000000 0.000000
# [3,] 0.02027867 0.1056561 0.1531535 9.18986 4.475805 1.163691
# 
# attr(,"intermediates")$base
#            [,1]      [,2]      [,3]     [,4]     [,5]     [,6]
# [1,] 0.02027867 0.1056561 0.1531535 1.586141 1.000000 1.163691
# [2,] 0.03577136 0.1361256 0.1940602 1.611075 4.475805 1.000000
# [3,]         NA        NA        NA       NA       NA       NA
# 
# attr(,"intermediates")$lq
# [1] -2.454324 -4.147482  0.000000
# 
# attr(,"vals")
# [1] 0.02027867 0.10565610 0.15315349 9.18985927 4.47580502 1.16369099
# attr(,"logComp")
# [1] -6.601807

#--------------------------------------------------
# a full tree
#-------------------------------------------------- 

tree <- read.tree(text="((((0:0.461876,(1:0.307717,(2:0.231825,3:0.231825):0.075892):0.154159):0.425922,((4:0.244819,5:0.244819):0.004749,6:0.249568):0.638231):0.142051,7:1.029850):0.038423,(((8:0.510933,(9:0.427929,(10:0.119778,11:0.119778):0.308151):0.083004):0.007428,(12:0.488316,13:0.488316):0.030044):0.100160,14:0.618521):0.449752);")

states <- c(0, 1, 0, 2, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0)
names(states) <- c("0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14")

pars <- c(0.9, 0.8, 0.1, 0.2, 0.3, 0.5, 0.6)
lnL.7par <- make.gse2(tree, states)
names(pars) <- argnames(lnL.7par)
lnL.7par(pars)             # -23.39109

lnL <- constrain(lnL.7par, sA ~ sB)
lnL(pars[2:7])             # -23.93448

lnL <- constrain(lnL.7par, sAB ~ 0)
lnL(pars[-3])              # -23.22191

lnL <- constrain(lnL.7par, dB ~ dA)
lnL(pars[-6])              # -22.91692

find.mle(lnL.7par, pars, method="subplex")
# $par
#           sA           sB          sAB           xA           xB           dA 
# 1.446606e+00 4.688561e-01 1.324631e-06 2.720090e-09 3.455288e-08 1.130573e+00 
#           dB 
# 2.564782e+00 
# $lnLik
# [1] -18.70781

find.mle(constrain(lnL.7par, dA ~ dB), pars[-6], method="subplex")
# $par
#           sA           sB          sAB           xA           xB           dB 
# 1.480193e+00 3.901173e-01 1.767147e-08 1.594058e-08 9.047256e-07 1.275068e+00 
# $lnLik
# [1] -18.84392

lnL.7par(pars, root.p=c(0.9, 0.1, 0))   # warning
lnL.7par(pars, root.p=c(0.9, 0.1), root=diversitreeGSE:::ROOT.GIVEN)  # error
lnL.7par(pars, root.p=c(0.9, 0.1, 0), root=diversitreeGSE:::ROOT.GIVEN)
# -23.26696

lnL.7par(pars, root=diversitreeGSE:::ROOT.EQUI)    # -24.00041
lnL.7par(pars, root=diversitreeGSE:::ROOT.FLAT)    # -23.94198

lnL.7par(pars, condition.surv=FALSE)               # -23.45394
